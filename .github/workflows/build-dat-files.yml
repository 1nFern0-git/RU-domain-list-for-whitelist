name: Build and Release DAT Files

on:
  # Run daily at 03:00 UTC
  schedule:
    - cron: '0 3 * * *'
  
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Compile protobuf definitions
        run: |
          cd scripts
          python -m grpc_tools.protoc -I. --python_out=. common.proto
      
      - name: Parse source DAT files
        run: |
          cd scripts
          python parse_dat.py \
            --source-repo runetfreedom/russia-v2ray-rules-dat \
            --geosite-categories category-ru ru-blocked ru-available-only-inside category-ads-all \
            --geoip-categories ru ru-blocked private \
            --output-dir ../output
      
      - name: Build merged DAT files
        run: |
          cd scripts
          python build_dat.py \
            --extracted-geosite ../output/extracted_geosite.dat \
            --extracted-geoip ../output/extracted_geoip.dat \
            --whitelist-domains ../domains/ru/category-ru \
            --whitelist-ips ../IPs \
            --output-dir ../output
      
      - name: Generate release version
        id: version
        run: |
          VERSION=$(date -u +%Y%m%d)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"
      
      - name: Check if release exists
        id: check_release
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if gh release view "$VERSION" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release $VERSION already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Release $VERSION does not exist"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Delete existing release if exists
        if: steps.check_release.outputs.exists == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Deleting existing release $VERSION..."
          gh release delete "$VERSION" --yes
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body: |
            # Automated DAT Files Build
            
            **Build Date:** ${{ steps.version.outputs.version }}
            
            ## Files
            
            - **geosite.dat** - Combined domain categories
            - **geoip.dat** - Combined IP categories
            
            ## Included Categories
            
            ### geosite.dat
            - `category-ru` - Russian domains from runetfreedom
            - `ru-blocked` - Blocked domains in Russia
            - `ru-available-only-inside` - Domains available only inside Russia
            - `category-ads-all` - All ads domains
            - `whitelist` - Verified whitelist domains from this repository
            
            ### geoip.dat
            - `ru` - Russian IP ranges
            - `ru-blocked` - Blocked IP ranges
            - `private` - Private IP ranges
            - `whitelist` - Verified whitelist IPs from this repository
            
            ## Usage
            
            Download and place these files in your v2ray/Xray configuration directory.
            
            ```json
            {
              "routing": {
                "domainStrategy": "IPIfNonMatch",
                "rules": [
                  {
                    "type": "field",
                    "domain": ["geosite:whitelist"],
                    "outboundTag": "direct"
                  },
                  {
                    "type": "field",
                    "ip": ["geoip:whitelist"],
                    "outboundTag": "direct"
                  }
                ]
              }
            }
            ```
          files: |
            output/geosite.dat
            output/geoip.dat
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
